syntax = "proto3";

package oj.backend;

import "google/protobuf/timestamp.proto";
import "google/protobuf/empty.proto";

// Search
enum SortBy {
  UploadDate = 0;
  ACRate = 1;
  SubmitCount = 2;
  Score = 3;
  Difficulty = 4;
}

message Page {
  uint32 offset = 1;
  uint32 amount = 2;
}

message ListRequest {
  SortBy sort_by = 1;
  bool reverse = 2;
  Page page = 3;
}

message TextSearchRequest {
  SortBy sort_by = 1;
  Page page = 2;
  string text = 3;
}

// Announcements
message Announcements { repeated AnnouncementInfo list = 1; }

message AnnouncementInfo {
  AnnouncementId id = 1;
  string title = 2;
  google.protobuf.Timestamp upload_date = 3;
}

message AnnouncementFullInfo {
  AnnouncementInfo info = 1;
  UserId author = 2;
  string content = 3;
  bool public = 4;
}

message AnnouncementId { int32 id = 1; }

message AnnouncementLink {
  AnnouncementId announcement_id = 1;
  ContestId contest_id = 2;
}

message CreateAnnouncementRequest{
  message Info{
    string title = 1;
    string content = 2;
  }
  Info info = 1;
  ContestId id = 2;
}

message UpdateAnnouncementRequest{
  message Info{
    optional string title = 1;
    optional string content = 2;
  }
  Info info = 1;
  ContestId id = 2;
}

service AnnouncementSet {
  rpc List(ListRequest) returns (stream AnnouncementInfo);
  rpc SearchByText(TextSearchRequest) returns (stream AnnouncementInfo);
  rpc SearchByTag(TextSearchRequest) returns (stream AnnouncementInfo);
  rpc FullInfo(AnnouncementId) returns (AnnouncementFullInfo);

  rpc Create(CreateAnnouncementRequest) returns (AnnouncementId);
  rpc Update(UpdateAnnouncementRequest) returns (google.protobuf.Empty);
  rpc Remove(AnnouncementId) returns (google.protobuf.Empty);

  rpc Link(AnnouncementLink) returns (google.protobuf.Empty);
  rpc Unlink(AnnouncementLink) returns (google.protobuf.Empty);

  rpc Publish(AnnouncementId) returns (google.protobuf.Empty);
  rpc Unpublish(AnnouncementId) returns (google.protobuf.Empty);
}

// Educations
message Educations { repeated EducationInfo list = 1; }

message EducationInfo {
  EducationId id = 1;
  string title = 2;
}

message EducationFullInfo {
  EducationInfo info = 1;
  string content = 2;
  repeated ProblemId problems = 3;
}

message EducationId { int32 id = 1; }

message EducationLink {
  EducationId education_id = 1;
  ProblemId problem_id = 2;
}

message CreateEducationRequest{
  message Info{
    string title = 1;
    string content = 2;
  }
  Info info = 1;
  EducationId id =2;
}

message UpdateEducationRequest{
  message Info{
    optional string title = 1;
    optional string content = 2;
  }
  Info info = 1;
  EducationId id =2;
}

service EducationSet {
  rpc List(ListRequest) returns (stream EducationInfo);
  rpc SearchByText(TextSearchRequest) returns (stream EducationInfo);
  rpc SearchByTag(TextSearchRequest) returns (stream EducationInfo);
  rpc FullInfo(EducationId) returns (EducationFullInfo);

  rpc Create(CreateEducationRequest) returns (google.protobuf.Empty);
  rpc Update(UpdateEducationRequest) returns (google.protobuf.Empty);
  rpc Remove(EducationId) returns (google.protobuf.Empty);

  rpc Link(EducationLink) returns (google.protobuf.Empty);
  rpc Unlink(EducationLink) returns (google.protobuf.Empty);
}

// Problems
message Problems { repeated ProblemInfo list = 1; }

message ProblemInfo {
  ProblemId id = 1;
  string title = 2;
  uint32 submit_count = 3;
  float ac_rate = 4;
}

message ProblemId { int32 id = 1; }

message ProblemFullInfo {
  ProblemInfo info = 1;
  string content = 2;
  string tags = 8;
  optional EducationId education_id = 3;
  uint32 difficulty = 4;
  bool public = 5;
  uint64 time = 6;
  int64 memory = 7;
}

message Case {
  repeated bytes inputs = 1;
  repeated bytes outputs = 2;
}

message Testcases{
  repeated TestcaseId list=1;
}

message ProblemLink {
  ContestId contest_id = 1;
  ProblemId problem_id = 2;
}

message CreateProblemRequest {
  message Info {
    string title = 1;
    uint32 difficulty = 2;
    uint64 time = 4;
    int64 memory = 5;
    string tags = 6;
    string content = 7;
    Testcases tests = 8;
  };
  Info info = 1;
}

message UpdateProblemRequest {
  message Info {
    optional string title = 1;
    optional uint32 difficulty = 2;
    optional uint64 time = 4;
    optional int64 memory = 5;
    optional string tags = 6;
    optional string content = 7;
    optional uint32 submit_count = 3;
    optional float ac_rate = 8;
    optional Testcases tests = 9;
  };
  Info info = 1;
  ProblemId id = 3;
}

service ProblemSet {
  rpc List(ListRequest) returns (stream ProblemInfo);
  rpc SearchByText(TextSearchRequest) returns (stream ProblemInfo);
  rpc SearchByTag(TextSearchRequest) returns (stream ProblemInfo);
  rpc FullInfo(ProblemId) returns (ProblemFullInfo);

  rpc Create(CreateProblemRequest) returns (ProblemId);
  rpc Update(UpdateProblemRequest) returns (google.protobuf.Empty);
  rpc Remove(ProblemId) returns (google.protobuf.Empty);

  rpc Link(ProblemLink) returns (google.protobuf.Empty);
  rpc Unlink(ProblemLink) returns (google.protobuf.Empty);

  rpc Publish(ProblemId) returns (google.protobuf.Empty);
  rpc Unpublish(ProblemId) returns (google.protobuf.Empty);

  rpc FullInfoByContest(ProblemLink) returns (ProblemFullInfo);
  rpc ListByContest(ProblemLink) returns (stream ProblemInfo);
}

message TestcaseId { int32 id = 1; }

message Testcase {
  TestcaseId id = 1;
  uint32 score = 2;
  repeated Case cases = 3;
}

message TestcaseFullInfo {
  TestcaseId id = 1;
  uint32 score = 2;
  repeated bytes inputs = 3;
  repeated bytes outputs = 4;
}

message TestcaseLink{
  TestcaseId testcase_id = 1;
  ProblemId problem_id = 2;
}

message CreateTestcaseRequest {
  message Info {
    uint32 score = 2;
    repeated bytes inputs = 3;
    repeated bytes outputs = 4;
  };
  Info info = 1;
}

message UpdateTestcaseRequest {
  message Info {
    uint32 score = 2;
    repeated bytes inputs = 3;
    repeated bytes outputs = 4;
  };
  Info info = 1;
  ProblemId id = 3;
}
// Testcase
service TestcaseSet {
  rpc Create(CreateTestcaseRequest) returns (ProblemId);
  rpc Update(UpdateTestcaseRequest) returns (google.protobuf.Empty);
  rpc Remove(ProblemId) returns (google.protobuf.Empty);

  rpc Link(TestcaseLink) returns (google.protobuf.Empty);
  rpc Unlink(TestcaseLink) returns (google.protobuf.Empty);

  rpc FullInfoByProblem(TestcaseLink) returns (TestcaseFullInfo);
  rpc ListByProblem(TestcaseLink) returns (stream Testcase);
}


// Contest
message ContestId { int32 id = 1; }

message Contests { repeated ContestInfo list = 1; }

message ContestInfo {
  ContestId id = 1;
  string title = 2;
  uint32 participant_count = 3;
  google.protobuf.Timestamp begin = 4;
  google.protobuf.Timestamp end = 5;
  bool need_password = 6;
}

message ContestFullInfo {
  ContestInfo info = 1;
  string content = 2;
  UserId hoster = 3;
  repeated ProblemId problems = 4;
}

message UserRank {
  UserId user_id = 1;
  int32 score = 2;
  uint32 rank = 3;
}

message UserRanks { repeated UserRank list = 1; }

message CreateContestRequest {
  message Info {
    string title = 1;
    google.protobuf.Timestamp begin = 2;
    google.protobuf.Timestamp end = 3;
    string content = 4;
    optional string password =5;
  }
  Info info = 1;
  ContestId id = 2;
}

message UpdateContestRequest {
  message Info {
    optional string title = 1;
    optional google.protobuf.Timestamp begin = 2;
    optional google.protobuf.Timestamp end = 3;
    optional string content = 4;
    optional string password =5;
  }
  Info info = 1;
  ContestId id = 2;
}

service ContestSet {
  rpc List(ListRequest) returns (stream ContestInfo);
  rpc SearchByText(TextSearchRequest) returns (stream ContestInfo);
  rpc SearchByTag(TextSearchRequest) returns (stream ContestInfo);
  rpc FullInfo(ContestId) returns (ContestFullInfo);

  rpc Create(CreateContestRequest) returns (google.protobuf.Empty);
  rpc Update(UpdateContestRequest) returns (google.protobuf.Empty);
  rpc Remove(ContestId) returns (google.protobuf.Empty);

  rpc Join(ContestId) returns (google.protobuf.Empty);
  rpc Exit(ContestId) returns (google.protobuf.Empty);

  rpc Rank(ListRequest) returns (UserRanks);
}

// Submit
enum JudgeState {
  AC = 0;
  NA = 1;
  WA = 2;
  CE = 3;
  RE = 4;
  RF = 5;
  TLE = 6;
  MLE = 7;
  OLE = 8;
}

message SubmitId { int32 id = 1; }

message Submits { repeated SubmitInfo list = 1; }

message SubmitUpload {
  SubmitId id = 1;
  bytes code = 2;
}

message SubmitInfo {
  SubmitId id = 1;
  google.protobuf.Timestamp upload_time = 3;
  uint64 time = 4;
  uint64 peak_mem = 5;
  uint64 score = 6;
  JudgeState state = 7;
}

message SubmitStatus {
  JudgeState state = 1;
  uint64 time = 2;
  uint64 peak_mem = 3;
}

message CreateSubmitRequest {
  message Info {
    bytes code = 1;
    ProblemId problem_id = 2;
  }
  Info info = 1;
  SubmitId id = 2;
}

service SubmitSet {
  rpc List(ListRequest) returns (Submits);
  rpc SearchByText(TextSearchRequest) returns (Submits);
  rpc SearchByTag(TextSearchRequest) returns (Submits);
  rpc Info(SubmitId) returns (SubmitInfo);

  rpc Create(CreateSubmitRequest) returns (google.protobuf.Empty);
  rpc Remove(SubmitId) returns (google.protobuf.Empty);

  rpc Follow(SubmitId) returns (stream SubmitStatus);
  rpc Rejudge(SubmitId) returns (google.protobuf.Empty);
}

// User
message UserId { int32 id = 1; }

message UserInfo {
  string username = 1;
  int32 score = 2;
  UserId id = 3;
}

message UserFullInfo {
  UserInfo info = 1;
  bytes hashed_pwd = 2;
}

message Users { repeated UserInfo list = 1; }

message CreateUserRequest {
  message Info {
    string username = 1;
    bytes raw_pwd = 2;
  }
  Info info = 1;
  UserId id = 2;
}

message UpdateUserRequest {
  message Info {
    optional string username = 1;
    optional bytes raw_pwd = 2;
  }
  Info info = 1;
  UserId id = 2;
}

service UserSet {
  rpc List(ListRequest) returns (stream UserInfo);
  rpc SearchByText(TextSearchRequest) returns (stream UserInfo);
  rpc SearchByTag(TextSearchRequest) returns (stream UserInfo);
  rpc FullInfo(UserId) returns (UserFullInfo);

  rpc Create(CreateUserRequest) returns (google.protobuf.Empty);
  rpc Update(UpdateUserRequest) returns (google.protobuf.Empty);
  rpc Remove(UserId) returns (google.protobuf.Empty);
}

message TokenInfo {
  Token token = 1;
  bytes permission = 2;
  google.protobuf.Timestamp expiry = 3;
}

message Token { bytes signature = 1; }
message Tokens { repeated Token list = 1; }

message LoginRequest {
  string usertitle = 1;
  bytes raw_pwd = 2;
}

service TokenSet {
  rpc List(ListRequest) returns (stream Token);

  rpc Create(LoginRequest) returns (TokenInfo);
  rpc Refresh(Token) returns (TokenInfo);

  rpc Logout(Token) returns (google.protobuf.Empty);
}


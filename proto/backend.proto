syntax = "proto3";

package oj.backend;

import "google/protobuf/timestamp.proto";
import "google/protobuf/empty.proto";

/* 
 * all time are in unit of nanosecond
 * all memory are in unit of byte
 */

// How judge assert input
enum MatchRule {
  // exactly same
  ExactSame = 0;
  // assert segment between space or newline, empty segments are also compare
  IgnoreSNL = 1;
  // assert segment between space or newline, empty segments are ignored
  SkipSNL = 2;
}

// Search
enum SortBy {
  UploadDate = 0;
  ACRate = 1;
  SubmitCount = 2;
  Score = 3;
  Difficulty = 4;
  Rank = 5;
  UserCount = 6;
}

message ListRequest {
  // Parameters new list paginator
  message Create {
    SortBy sort_by = 1;
    string text = 3;
    bool reverse = 2;
  }
  oneof request {
    Create create = 1;
    // session for list pagination
    string session = 2;
  }
  // expected size of list
  uint32 size = 3;
}

message TextSearchRequest {
  oneof request {
    // text to search
    string text = 1;
    // session for list pagination
    string session = 2;
  }
  // expected size of list
  uint32 size = 3;
}

message Case {
  repeated bytes inputs = 1;
  repeated bytes outputs = 2;
}

message Testcases { repeated TestcaseId list = 1; }

// Submit

// I don't want to write docs
enum JudgeResultState {
  AC = 0;
  NA = 1;
  WA = 2;
  CE = 3;
  RE = 4;
  RF = 5;
  TLE = 6;
  MLE = 7;
  OLE = 8;
}

message SubmitId { int32 id = 1; }

message Submits { repeated SubmitInfo list = 1; }

message SubmitUpload {
  SubmitId id = 1;
  bytes code = 2;
}

message SubmitInfo {
  SubmitId id = 1;
  google.protobuf.Timestamp upload_time = 3;
  uint64 time = 4;
  uint64 peak_mem = 5;
  uint64 score = 6;
  JudgeResult state = 7;
}

message JudgeResult {
  // assertion code
  JudgeResultState status = 1;
  // the time in nanosecond
  optional uint64 max_time = 2;
  // the peak memory usage
  optional uint64 max_mem = 3;
}

message SubmitStatus {
  oneof task {
    // number of test case running(or finished)
    int32 case = 1;
    JudgeResult result = 2;
  }
}

message CreateSubmitRequest {
  message Info {
    bytes code = 1;
    ProblemId problem_id = 2;
  }
  Info info = 1;
  SubmitId id = 2;
  ProblemId problem = 3;
  string request_id = 4;
}

message RejudgeRequest {
  SubmitId id = 1;
  string request_id = 2;
}

service SubmitSet {
  rpc List(ListRequest) returns (Submits);
  rpc SearchByText(TextSearchRequest) returns (Submits);
  rpc SearchByTag(TextSearchRequest) returns (Submits);
  rpc Info(SubmitId) returns (SubmitInfo);

  rpc Create(CreateSubmitRequest) returns (SubmitId);
  rpc Remove(SubmitId) returns (google.protobuf.Empty);

  // are not guarantee to yield status
  rpc Follow(SubmitId) returns (stream SubmitStatus);
  rpc Rejudge(RejudgeRequest) returns (google.protobuf.Empty);
}

// Announcements
message AnnouncementId { int32 id = 1; }

message AnnouncementInfo {
  AnnouncementId id = 1;
  string title = 2;
  google.protobuf.Timestamp upload_date = 3;
}

message AnnouncementFullInfo {
  AnnouncementInfo info = 1;
  UserId author = 2;
  string content = 3;
  bool public = 4;
}

message ListAnnouncementResponse {
  repeated AnnouncementInfo list = 1;
  string next_page_token = 2;
}

message AnnouncementLink {
  AnnouncementId announcement_id = 1;
  ContestId contest_id = 2;
}

message CreateAnnouncementRequest {
  message Info {
    string title = 1;
    string content = 2;
  }
  Info info = 1;
  string request_id = 2;
}

message UpdateAnnouncementRequest {
  message Info {
    optional string title = 1;
    optional string content = 2;
  }
  Info info = 1;
  AnnouncementId id = 2;
  string request_id = 3;
}

service AnnouncementSet {
  rpc List(ListRequest) returns (ListAnnouncementResponse);
  rpc SearchByText(TextSearchRequest) returns (ListAnnouncementResponse);
  rpc SearchByTag(TextSearchRequest) returns (ListAnnouncementResponse);
  rpc FullInfo(AnnouncementId) returns (AnnouncementFullInfo);

  rpc Create(CreateAnnouncementRequest) returns (AnnouncementId);
  rpc Update(UpdateAnnouncementRequest) returns (google.protobuf.Empty);
  rpc Remove(AnnouncementId) returns (google.protobuf.Empty);

  rpc Link(AnnouncementLink) returns (google.protobuf.Empty);
  rpc Unlink(AnnouncementLink) returns (google.protobuf.Empty);

  rpc Publish(AnnouncementId) returns (google.protobuf.Empty);
  rpc Unpublish(AnnouncementId) returns (google.protobuf.Empty);

  rpc ListByContest(AnnouncementLink) returns (ListAnnouncementResponse);
  rpc FullInfoByContest(AnnouncementLink) returns (AnnouncementFullInfo);
}

// Educations
message EducationId { int32 id = 1; }

message EducationInfo {
  EducationId id = 1;
  string title = 2;
}

message EducationFullInfo {
  EducationInfo info = 1;
  string content = 2;
  repeated ProblemId problems = 3;
}

message ListEducationResponse {
  repeated EducationInfo list = 1;
  string next_page_token = 2;
}

message EducationLink {
  EducationId education_id = 1;
  ProblemId problem_id = 2;
}

message CreateEducationRequest {
  message Info {
    string title = 1;
    string content = 2;
  }
  Info info = 1;
  string request_id = 2;
  ProblemId problem = 3;
}

message UpdateEducationRequest {
  message Info {
    optional string title = 1;
    optional string content = 2;
  }
  Info info = 1;
  EducationId id = 2;
  string request_id = 3;
}

service EducationSet {
  rpc List(ListRequest) returns (ListEducationResponse);
  rpc SearchByText(TextSearchRequest) returns (ListEducationResponse);
  rpc SearchByTag(TextSearchRequest) returns (ListEducationResponse);
  rpc FullInfo(EducationId) returns (EducationFullInfo);

  rpc Create(CreateEducationRequest) returns (google.protobuf.Empty);
  rpc Update(UpdateEducationRequest) returns (google.protobuf.Empty);
  rpc Remove(EducationId) returns (google.protobuf.Empty);

  rpc Link(EducationLink) returns (google.protobuf.Empty);
  rpc Unlink(EducationLink) returns (google.protobuf.Empty);

  rpc FullInfoByProblem(EducationLink) returns (EducationFullInfo);
}

// Problems
message ProblemId { int32 id = 1; }

message ProblemInfo {
  ProblemId id = 1;
  string title = 2;
  uint32 submit_count = 3;
  float ac_rate = 4;
}

message ProblemFullInfo {
  ProblemInfo info = 1;
  string content = 2;
  string tags = 8;
  optional EducationId education_id = 3;
  uint32 difficulty = 4;
  bool public = 5;
  uint64 time = 6;
  uint64 memory = 7;
  Testcases testcases = 9;
  // bool commit
}

message ListProblemResponse {
  repeated ProblemInfo list = 1;
  string next_page_token = 2;
}

message ProblemLink {
  ContestId contest_id = 1;
  ProblemId problem_id = 2;
}

message CreateProblemRequest {
  message Info {
    string title = 1;
    uint32 difficulty = 2;
    uint64 time = 4;
    uint64 memory = 5;
    string tags = 6;
    string content = 7;
    MatchRule match_rule = 9;
  };
  Info info = 1;
  string request_id = 2;
}

message UpdateProblemRequest {
  message Info {
    optional string title = 1;
    optional uint32 difficulty = 2;
    optional uint64 time = 4;
    optional uint64 memory = 5;
    optional string tags = 6;
    optional string content = 7;
    optional uint32 submit_count = 3;
    optional float ac_rate = 8;
    optional MatchRule match_rule = 10;
  };
  Info info = 1;
  ProblemId id = 2;
  string request_id = 3;
}

service ProblemSet {
  rpc List(ListRequest) returns (ListProblemResponse);
  rpc SearchByText(TextSearchRequest) returns (ListProblemResponse);
  rpc SearchByTag(TextSearchRequest) returns (ListProblemResponse);
  rpc FullInfo(ProblemId) returns (ProblemFullInfo);

  rpc Create(CreateProblemRequest) returns (ProblemId);
  rpc Update(UpdateProblemRequest) returns (google.protobuf.Empty);
  rpc Remove(ProblemId) returns (google.protobuf.Empty);

  rpc Link(ProblemLink) returns (google.protobuf.Empty);
  rpc Unlink(ProblemLink) returns (google.protobuf.Empty);

  rpc Publish(ProblemId) returns (google.protobuf.Empty);
  rpc Unpublish(ProblemId) returns (google.protobuf.Empty);

  rpc FullInfoByContest(ProblemLink) returns (ProblemFullInfo);
  rpc ListByContest(ContestId) returns (stream ProblemInfo);
}

// Testcase
message TestcaseId { int32 id = 1; }

message TestcaseInfo {
  TestcaseId id = 1;
  uint32 score = 2;
  repeated Case cases = 3;
}

message TestcaseFullInfo {
  TestcaseId id = 1;
  uint32 score = 2;
  repeated bytes inputs = 3;
  repeated bytes outputs = 4;
}

message ListTestcaseResponse {
  repeated TestcaseInfo list = 1;
  string next_page_token = 2;
}

message TestcaseLink {
  TestcaseId testcase_id = 1;
  ProblemId problem_id = 2;
}

message CreateTestcaseRequest {
  message Info {
    uint32 score = 2;
    optional bytes inputs = 3;
    optional bytes outputs = 4;
  };
  Info info = 1;
  string request_id = 2;
}

message UpdateTestcaseRequest {
  message Info {
    optional uint32 score = 2;
    optional bytes inputs = 3;
    optional bytes outputs = 4;
  };
  Info info = 1;
  TestcaseId id = 2;
  string request_id = 3;
}
// Testcase
service TestcaseSet {
  rpc Create(CreateTestcaseRequest) returns (TestcaseId);
  rpc Update(UpdateTestcaseRequest) returns (google.protobuf.Empty);
  rpc Remove(TestcaseId) returns (google.protobuf.Empty);

  rpc Link(TestcaseLink) returns (google.protobuf.Empty);
  rpc Unlink(TestcaseLink) returns (google.protobuf.Empty);

  rpc FullInfoByProblem(TestcaseLink) returns (TestcaseFullInfo);
  rpc ListByProblem(TestcaseLink) returns (ListTestcaseResponse);
}

// Contest
message ContestId { int32 id = 1; }

message ContestInfo {
  ContestId id = 1;
  string title = 2;
  uint32 participant_count = 3;
  google.protobuf.Timestamp begin = 4;
  google.protobuf.Timestamp end = 5;
  bool need_password = 6;
}

message ContestFullInfo {
  ContestInfo info = 1;
  string content = 2;
  UserId hoster = 3;
  repeated ProblemId problems = 4;
}

message ListContestResponse {
  repeated ContestInfo list = 1;
  string next_page_token = 2;
}

message CreateContestRequest {
  message Info {
    string title = 1;
    google.protobuf.Timestamp begin = 2;
    google.protobuf.Timestamp end = 3;
    string content = 4;
    optional string password = 5;
  }
  Info info = 1;
  string request_id = 2;
}

message UpdateContestRequest {
  message Info {
    optional string title = 1;
    optional google.protobuf.Timestamp begin = 2;
    optional google.protobuf.Timestamp end = 3;
    optional string content = 4;
    optional string password = 5;
  }
  Info info = 1;
  ContestId id = 2;
  string request_id = 3;
}

message UserRank {
  UserId user_id = 1;
  int32 score = 2;
  uint32 rank = 3;
}

message ListRankResponse {
  repeated UserRank list = 1;
  string next_page_token = 2;
}

service ContestSet {
  rpc List(ListRequest) returns (ListContestResponse);
  rpc SearchByText(TextSearchRequest) returns (ListContestResponse);
  rpc SearchByTag(TextSearchRequest) returns (ListContestResponse);
  rpc FullInfo(ContestId) returns (ContestFullInfo);

  rpc Create(CreateContestRequest) returns (google.protobuf.Empty);
  rpc Update(UpdateContestRequest) returns (google.protobuf.Empty);
  rpc Remove(ContestId) returns (google.protobuf.Empty);

  rpc Join(ContestId) returns (google.protobuf.Empty);
  rpc Exit(ContestId) returns (google.protobuf.Empty);

  rpc Rank(ListRequest) returns (ListRankResponse);
}

// User
message UserId { int32 id = 1; }

message UserInfo {
  string username = 1;
  int32 score = 2;
  UserId id = 3;
}

message UserFullInfo {
  UserInfo info = 1;
  bytes hashed_pwd = 2;
}

message ListUserResponse {
  repeated UserInfo list = 1;
  string next_page_token = 2;
}

message CreateUserRequest {
  message Info {
    string username = 1;
    bytes raw_pwd = 2;
  }
  Info info = 1;
  UserId id = 2;
}

message UpdateUserRequest {
  message Info {
    optional string username = 1;
    optional bytes raw_pwd = 2;
  }
  Info info = 1;
  UserId id = 2;
  string request_id = 3;
}

service UserSet {
  rpc List(ListRequest) returns (ListUserResponse);
  rpc SearchByText(TextSearchRequest) returns (ListUserResponse);
  rpc SearchByTag(TextSearchRequest) returns (ListUserResponse);
  rpc FullInfo(UserId) returns (UserFullInfo);

  rpc Create(CreateUserRequest) returns (google.protobuf.Empty);
  rpc Update(UpdateUserRequest) returns (google.protobuf.Empty);
  rpc Remove(UserId) returns (google.protobuf.Empty);
}

message TokenInfo {
  Token token = 1;
  bytes permission = 2;
  google.protobuf.Timestamp expiry = 3;
}

message Token { bytes signature = 1; }
message Tokens { repeated Token list = 1; }

message LoginRequest {
  string usertitle = 1;
  bytes raw_pwd = 2;
}

service TokenSet {
  rpc List(UserId) returns (stream Token);

  rpc Create(LoginRequest) returns (TokenInfo);
  rpc Refresh(Token) returns (TokenInfo);

  rpc Logout(Token) returns (google.protobuf.Empty);
}
